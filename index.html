<html>
  <head>
    <script src="face-api.js"></script>
    <script src="rem.js"></script>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-2.1.1.min.js"
    ></script>
  </head>
  <body>
    <script>
      let NUM_VIDEOS = 3;
      let lastTimestamp = 0;
      let avgDelta = 1;
      let l_rat_window = [];
      let r_rat_window = [];
      let l_rat_ema = 0;
      let r_rat_ema = 0;
      let blinking = false;
      let bcounter = 0;
      let videoCache = [];
      let audioContext = null;
      let audioBuffer = null;
      let currentSource = null;
      let introVideoPlaying = false;
      let waitingForFirstBlink = false;
      let appActive = false;

      async function run() {
        await faceapi.loadTinyFaceDetectorModel("model");
        await faceapi.loadFaceLandmarkTinyModel("model");

        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        const camera = $("#inputVideo").get(0);
        camera.srcObject = stream;

        videoCache = precacheVideos(NUM_VIDEOS);
        const audioData = await loadAudio("001.mp3");
        audioContext = audioData.audioContext;
        audioBuffer = audioData.audioBuffer;

        // Hide loading text and show intro video
        const loadingContainer = document.getElementById("loadingContainer");
        const introVideoContainer = document.getElementById("introVideoContainer");
        const introVideo = document.getElementById("introVideo");

        if (loadingContainer) {
          loadingContainer.style.display = "none";
        }

        if (introVideoContainer && introVideo) {
          introVideoContainer.style.display = "flex";
          introVideoPlaying = true;

          // Set up video end handler
          introVideo.addEventListener("ended", function() {
            introVideoPlaying = false;
            waitingForFirstBlink = true;
            console.log("Intro video ended. Waiting for first blink...");
          });

          // Start playing the video
          introVideo.play();
        }
      }

      async function detect() {
        const camera = $("#inputVideo").get(0);
        const leftEye = [36, 37, 38, 39, 40, 41];
        const rightEye = [42, 43, 44, 45, 46, 47];

        if (camera.paused || camera.ended) return setTimeout(() => detect());

        // Skip blink detection while intro video is playing
        if (introVideoPlaying) {
          setTimeout(() => detect());
          return;
        }

        const detection = await faceapi
          .detectSingleFace(
            camera,
            new faceapi.TinyFaceDetectorOptions(512, 0.5)
          )
          .withFaceLandmarks(true);

        if (detection != null) {
          const canvas = $("#overlay").get(0);
          faceapi.matchDimensions(canvas, camera, true);

          const left = getSubset(detection.landmarks.positions, leftEye);
          const right = getSubset(detection.landmarks.positions, rightEye);

          var ctx = canvas.getContext("2d");

          for (var i = 0; i < left.length; i++) {
            ctx.fillRect(left[i]._x, left[i]._y, 3, 3);
            ctx.fillRect(right[i]._x, right[i]._y, 3, 3);
          }

          const [l_rat, lx, ly, lw, lh] = getRatio(left, [5000, 5000]);
          const [r_rat, rx, ry, rw, rh] = getRatio(right, [5000, 5000]);

          l_rat_window.unshift(l_rat);
          r_rat_window.unshift(r_rat);

          if (l_rat_window.length > 5) l_rat_window.pop();
          if (r_rat_window.length > 5) r_rat_window.pop();

          l_rat_ema += (l_rat - l_rat_ema) * 0.2;
          r_rat_ema += (r_rat - r_rat_ema) * 0.2;

          if (
            l_rat_ema > 1.05 * Math.min(...l_rat_window) &&
            r_rat_ema > 1.05 * Math.min(...r_rat_window)
          ) {
            if (blinking == false) {
              bcounter += 1;
              console.log(
                "blink " + bcounter,
                1000 / avgDelta,
                l_rat_ema,
                Math.min(...l_rat_window)
              );
              blinking = true;

              // Handle first blink after intro video
              if (waitingForFirstBlink) {
                console.log("First blink detected! Activating app...");
                waitingForFirstBlink = false;
                appActive = true;

                // Hide intro video
                const introVideoContainer = document.getElementById("introVideoContainer");
                if (introVideoContainer) {
                  introVideoContainer.style.display = "none";
                }

                // Show main content
                const mainContent = document.getElementById("mainContent");
                if (mainContent) {
                  mainContent.style.display = "flex";
                }

                // Start audio playback
                if (audioBuffer && audioContext) {
                  currentSource = playAudioFrom(audioContext, audioBuffer, currentSource, 0);
                }
              }
              // Normal blink behavior when app is active
              else if (appActive) {
                currentSource = blink(bcounter, NUM_VIDEOS, audioBuffer, audioContext, currentSource);
              }
            }
          } else blinking = false;
        }

        const timeStats = updateTimeStats(lastTimestamp, avgDelta, performance.now());
        lastTimestamp = timeStats.lastTimestamp;
        avgDelta = timeStats.avgDelta;

        setTimeout(() => detect());
      }

      $(document).ready(function () {
        run();
      });
    </script>

    <div
      id="videoContainer"
      style="position: absolute; top: 0; left: 0; opacity: 0; z-index: 10"
      class="margin"
    >
      <video
        onloadedmetadata="detect(this)"
        id="inputVideo"
        autoplay
        muted
        playsinline
      ></video>
    </div>
    <div
      id="mainContent"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: none;
        background: black;
        align-items: center;
        justify-content: center;
      "
    >
      <video
        id="blinkVideo"
        src="vid/001.mp4"
        autoplay
        loop
        muted
        playsinline
      ></video>
      <canvas id="overlay" style="position: absolute; top: 0; left: 0" />
    </div>
    <div
      id="loadingContainer"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: white;
        font-family: monospace;
        font-size: 24px;
      "
    >
      loading
    </div>
    <div
      id="introVideoContainer"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      "
    >
      <video
        id="introVideo"
        src="0001.mp4"
        muted
        playsinline
      ></video>
    </div>
  </body>
</html>
